# CDN 3.0 协议说明

## 摘要
## 目录
## 简介
## 贡献者
本协议说明，由CDN联盟成员（熊猫直播、网宿科技、星域CDN、腾讯云、金山云、百度云、阿里云、声网、七牛云、帝联科技）共同制定完成，CDN联盟CDN3.0项目组负责维护。
## 定义
## 版本记录
|版本|更新信息|更新者|日期|
|---|---|---|---|
|0.0.1|初稿|姜雨晴(Panda TV)|20171026|

## 协议
该协议可以基于TCP/UDP或其他传输层、应用层协议。用于客户端到CDN、CDN到CDN、CDN到业务能力方的音视频流及信令传输。

### 时间戳格式

### 信息
通用信息
- 协议版本号：固定为01
- 类别：音频 视频 信令（08 09 18）
---
音视频流及信令信息  
- 端ID: 用户唯一标记符
- 频道ID: 频道ID
- 流ID: 流标记符 （存在单个频道多条流的情况）
- 可靠等级：可靠传输、非可靠传输
- 相对时间戳：相对于视频起始时间的标记时间。断流状态始终为0.
- 绝对时间戳：非完全可靠的绝对时间戳，用于延迟估算等。不能作为PTS等视频时间点的计算依据。
- 压缩格式：payload的压缩模式
- 加密模式：payload的加密模式 （先压缩后加密的原则）
- payload长度
---
路由信息  
- 路由模式：广播 组播 单播
- 单播模式 client id：目的用户的标识符
- 组播模式 chennel个数 + (chennel id, chennel id, chennel id...) + client个数 + （client id, client id, client id...)
- 广播模式 
---
payload

### 传输
该传输协议，可以依赖于其他底层传输协议进行通信，由端到CDN边缘节点可基于WebSocket、HTTP链接等应用层协议、也可直接基于TCP进行传输通信。

#### 传输流程
- 备选方案1(端到边缘节点长链请求)
```
端            边缘节点
|                 |
|---订阅--------->|
|<--确认订阅------|
|                 |
|           添加至订阅列表
|                 |
|<----数据--------|
|<----数据--------|
|----数据-------->|
|<----数据--------|
|<----心跳--------|
|----心跳-------->|
|                 |
|          超时移除订阅列表
```

```
转推节点             边缘节点
|                        |
|---定时查询订阅列表---->|
|<--订阅列表-------------|
|--------数据----------->|
|--------数据----------->|
|--------数据----------->|
|<-------数据------------|
|                        |
```

- 备选方案2(端到边缘节点短链请求)
```
端            边缘节点
|                 |
|---订阅--------->|
|                 |
|           添加至订阅列表
|                 |
|<--确认订阅------|

|---轮训请求----->|
|<--数据片列表----|

|---数据请求----->|
|<----数据--------|

|-----数据------->|
|<---接收相应-----|

|---取消订阅----->|
|                 |
|             取消订阅
|                 |
|<------取消------|
```

#### 转推流程
```
端                      CDN1节点               转推服务              CDN2节点
|                          |                      |                         |
|--底层协议(CDN通用协议)-->|                      |                         |
|                          |                      |                         |
|                     选择TCP/UDP                 |                         |
|                          |                      |                         |
|                          |---TCP/UDP私有协议--->|                         |
|                          |                      |                         |
|                          |                 公有协议转译                   |
|                          |                      |--TCP/UDP(CDN通用协议)-->|
|                          |                      |<-TCP/UDP(CDN通用协议)---|
|                          |                      |                         |
|                          |                 公有协议转译                   |
|                          |                      |                         |
|                          |<--TCP/UDP私有协议----|                         |
|                          |                      |                         |
|                      选择底层协议               |                         |
|                          |                      |                         |
|<--底层协议(CDN通用协议)--|                      |                         |
```

可用底层协议
- TCP(可靠)/UDP(非可靠) 
- WS(可靠/非可靠)
- HTTP轮训

### 音频视频信令消息基础信息头

```
0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
+  版本(1byte)  +       08      +      相对时间戳（3Byte）      +  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
+  相对时间戳   +相对时间戳扩展 +      绝对时间戳（4Byte）      +  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
+  绝对时间戳（4Byte）          +可靠等级(1byte)+    压缩/加密  +  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  
+  clientID（4Byte）                                            +  
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+  chennelID（4Byte）                                           +
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+  streamID（4Byte）                                            +
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+  data length（4Byte）                                         +
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+  路由信息                                                     +
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
+  payload                                                      +
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### 音频消息

- AAC specific header //@TODO: 与RTMP一致


### 视频消息
- AVC sequence header //@TODO: 与RTMP一致

### 信令消息
- onMetadata //@TODO: 与RTMP一致
- onTextdata 业务消息

@TODO: 路由方案
