# 1 设计目标
设计一种直播端到端延迟的测量方法，要求能够精确测量从视频采集到视频播放所花费的时间，并且能够适应转码情况以及各种播放格式(rtmp/flv/hls)。  
# 2 设计方案
本方案主要设计思路是在推流端插入时间戳，CDN保证时间戳不被更改，并转发给播放端，播放端在收到时间戳后，对比本地时间从而得出延迟。  
本方案要求推流端和播放端做到时钟同步，具体的同步方法不在本文档范围。  
## 2.1 方案选择
关于时间戳的插入方式主要有以下3种：
1. 使用保持flv时间戳方式  
   优点：实现比较简单  
   缺点：如果cdn转码帧率改变，时间戳会被更改。并且不支持hls的延迟的测量
2. 新增rtmp时间戳命令  
   优点：比方案3略微简单些  
   缺点：rtmp命令和视频帧数据关联性不强，强行关联到一起实现起来比较困难，并会引入一定的误差。并且不支持flv/hls延迟的测量。  
3. 使用SEI信息传输时间戳  
   优点:SEI是264标准的一部分，flv/hls/rtmp都可以支持，本身可以加在视频帧的头部，转码帧率变换也不会发生变化。  
   缺点：实现略微复杂一点，需要实现sei的封装格式。  
  
经以上对比，本方案采用SEI传输时间戳信息。

## 2.2 方案实现
### 2.2.1 
* **推流端**  
1. 在将原始图像数据送入编码器之前，将该图像PTS与当前时间戳相关联，然后将原始图像送入编码器。    
2. 从编码器获得编码后的数据后，根据编码后的PTS，获得相应的时间戳，封装在SEI中，并插入到视频帧数据NAL包前面。  

* **CDN**  
在非转码的情况下，直接转发原始数据。在转码的情况下，ffmpeg需要以下改动：  
1. 接收到SEI NAL以后，判断其是否包含时间戳，如果有将其写入随后视频帧的AVFrame结构体中的AVFrameSideData(需要新增类型)。
2. 在将原始图像数据送入编码器之前，将该图像PTS与AVFrame中的SEI相关联，然后将原始图像送入编码器。    
3. 从编码器获得编码后的数据后，根据编码后的PTS，获得相应的SEI NAL，并插入到视频帧数据NAL包前面。

* **播放端**
1. 接收到SEI NAL以后，判断其是否包含时间戳，如果有将其与随后的视频帧关联起来。
2. 当视频帧显示时获得相应的时间戳和本地时间，从而获得端到端延迟。  

* **SEI 时间戳格式**  
SEI 时间戳封装在**user_data_unregistered**中，具体格式如下：  
```
user_data_unregistered(payloadSize) {
    uuid_iso_11578 (b(128)
    magic_number   (b(64))
    time_stamp     (b(64))
}
```
其中magic_number=0x6c73736361707473("lsscapts"), time_stamp为64位unix时间戳，单位毫秒。
